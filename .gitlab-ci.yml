stages:
  - test
  - validate
  - deploy

# Pfad zu eurer docker-compose.yml
variables:
  DOCKER_COMPOSE_FILE: "infra/docker-compose.yml"

###############################
# 1) FRONTEND TESTS
###############################
frontend-tests:
  stage: test
  image: node:20-alpine
  script:
    - cd GlobeNotes
    - npm install
    - npm run build    # funktioniert IMMER — selbst bei fehlenden Tests
  only:
    - merge_requests
    - main

###############################
# 2) BACKEND BUILD (ohne Tests)
###############################
backend-tests:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd GlobeNotes/backend
    - mvn -q -B -DskipTests clean package
  only:
    - merge_requests
    - main

###############################
# 3) COMPOSE VALIDIEREN
###############################
validate_compose:
  stage: validate
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - apk add --no-cache docker-cli-compose
    - docker compose -f "$DOCKER_COMPOSE_FILE" config
  only:
    - main

###############################
# 4) DEPLOY (Simulation)
###############################
simulate_deploy:
  stage: deploy
  image: alpine:3.20
  script:
    - echo "Simulierter Deploy-Job für LB02..."
    - echo "Hier würden in einer echten Umgebung z.B. folgende Schritte erfolgen:"
    - echo "1) SSH-Verbindung zu einem Docker-Host aufbauen"
    - echo "2) git pull ausführen"
    - echo "3) docker compose pull && docker compose up -d"
    - echo "Da in der Schulumgebung kein echter Zielserver konfiguriert ist,"
    - echo "läuft dieser Job nur als Simulation erfolgreich durch."
  when: manual
  only:
    - main
